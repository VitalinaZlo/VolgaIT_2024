# Автоматическое распознавание адресов

![License](https://img.shields.io/github/license/VitalinaZlo/VolgaIT_2024?style=flat-square&label=License&color=e5573e)
![Python](https://img.shields.io/badge/build-3.12.7-brightgreen?style=flat-square&label=Python&color=52b4e5)
![Status](https://img.shields.io/badge/build-completed-green?style=flat-square&label=Status&color=3dc322)


**Automatic addresses recognition** — это проект, направленный на автоматическое распознавание адресов домов из диспечерских сообщений об отключениях коммунальных ресурсов с помощью `Natasha`.

Данный проект был создан для второго тура XV Международной цифровой олимпиады «Волга-IT'24» в дисциплине «Искусственный интеллект и анализ данных». Проект занял третье место в полуфинале.

## Задача проекта
Разработать программу, которая:

- Принимает на вход файл с комментариями диспетчеров об отключениях;
- Извлекает адреса из комментариев, используя доступный список адресов;
- Сохраняет УИДы распознанных домов в выходной файл.

## Структура исходных данных
- Классификатор (`volgait2024-semifinal-addresses.csv`) доступных адресов с полями:
   - **`house_uuid`** — УИД дома;
   - **`house_full_address`** — Полное текстовое описание адреса.

- Комментарии диспетчеров (`volgait2024-semifinal-task.csv`) с полями:
   - **`shutdown_id`** — ИД отключения;
   - **`comment`** — Текстовое описание отключения.

Код пишет в файл `volgait2024-semifinal-result-test.csv`.

## Принцип работы кода
В своём коде я использую библиотеку `Natasha` для извлечения адресных компонентов и Pandas для работы с данными в формате CSV. Код включает в себя несколько функций, каждая из которых выполняет определённую задачу в процессе обработки данных. Код запускался в `Visual Studio Code (Python 3.12.7)`.

### Natasha
Так как в ходе исследования библиотеки Natasha выяснилось, что `Natasha` в основном различает адреса с присутствием в тексте определенных якорей (таких как 'пос', 'ул.', 'дом' и т.п.), было принято решение модифицировать её внутренние правила. Был изменен файл `addr.py` (\.venv\Lib\site-packages\natasha\grammars\addr.py). Были объединены и удалены типы, которые не участвуют в определении адреса, а также расширены правила нахождения типа для типов 'посёлок', 'улица', 'дом' и 'корпус'.

Стоит заметить, что сейчас правила работают на основе полных адресов из файла `volgait2024-semifinal-addresses.csv`. К тому же, решение является масштабируемым, потому что при необходимости можно внести данные из классификатора ГАР ФИАС.

### Классификатор адресов
Перед основным кодом мы также подготавливаем не только диспетчерские комментарии, но и файл `volgait2024-semifinal-addresses.csv`. В нём мы отсекаем всё до 'Ульяновск г.' (включительно), так как классификатор в принципе для Ульяновска, а потом делим оставшиеся части адреса на три столбца. В первом столбце 'village' находятся все поселки, села и другие объекты (назовем их все поселениями), у которых есть свои улицы. Во втором столбце находятся поселения, у которых нет своих улиц, и собственно улицы (улицы, бульвары, проспекты и т.п.) либо города Ульяновска, либо поселений из первого столбца. В третьем находятся номера домов с корпусами, строениями и литерами.

Далее мы работаем именно с этим видом классификатора.


## Структура кода
1.  Импорт библиотек `(re, csv, pandas, natasha)`;

2.  Функция подготовки текста. `def normalize_text(text: str) -> str`;

3. Функция для определения начала адреса. `def is_beginning_of_address(_type:str) -> bool (вспомогательная к следующей функции)`;

4. Функция нахождение и получение типов частей адресов. `def finding_address_types(text:str) -> list`;

5. Функция упорядочивание адресов и нахождение их УИДов. `def extracting_address(addresses:list, addresses_df:pd.DataFrame) -> list`;

6. Загрузка файла с диспетчерскими комментариями;

7. Загрузка файла-классификатора и его подготовка к работе;

8. Создание файла `volgait2024-semifinal-result.csv` и запись УИДов в него. 
    * Причем, для файла предусмотрена функция дозаписи с интересующей нас строки.


## Функции
1. **normalize_text(text: str) -> str**

    Эта функция нормализует входной текст, удаляя ненужные символы и пробелы, а также обрабатывая специальные случаи.

    Основные шаги:

    * Замена чет и нечет на специальные обозначения — знак Тильды (~) обозначает четные диапазоны номеров домов, а Звездочка (*) нечетные;
    * Удаление части текста после "БЕЗ ХВС" (в самом разном виде), если данная конструкция имеется в комментарии;
    * Удаление ненужных символов и множественных пробелов;
    * Добавление специального символа '|' (вертикальной черты) в начале и конце строки для дальнейшей обработки и замена на него всех пробелов;

2. **is_beginning_of_address(_type: str) -> bool**

    Эта вспомогательная функция определяет, является ли текущий тип адреса началом адреса (улицей или посёлком).

3. **finding_address_types(text: str) -> list**

    Функция извлекает типы частей адреса и их значения из нормализованного текста.

    Основные шаги:
    * Использует addr_extractor для нахождения адресов;
    * Создаёт список addresses, в который добавляются найденные адреса с их типами и значениями;
    * Обрабатывает текущий адрес и добавляет его в список, если он начинается с улицы или посёлка;

4. **extracting_address(addresses: list, addresses_df: pd.DataFrame) -> list**

    Эта функция принимает список адресов и DataFrame-классификатор с полными адресами, чтобы извлечь УИДы.

    Основные шаги:
    * Инициализация списка houses_uuids для хранения найденных УИДов;
    * Итерация по адресам и извлечение значений для поселков, улиц и номеров домов.
    * Посёлки и улиц не обрабатываются, только знак '|' обратно заменяется на пробелы, а потом они добавляются в соответствующие переменные;
    * Номера домов и корпуса подвергаются дополнительной обработке. Если распознанный номер — это диазон, то в переменную для записи домов с помощью range записываются все номера домов от начала диапазона до его конца (включительно).
        * При этом, если номере дома с диапазоном присутствует литера, то сохраняются как все числа из диапазона без дроби, так и все числа из диапазона с литерой на конце;
        * Если же в номере дома с диапазоном присутствует символ '/', то сохраняются как все числа из диапазона без дроби, так и все числа из диапазона с числом-дробью;
        * Если в конце диапазона находится символ Тильды (~), то из диапазона сохраняются только четные числа;
        * Если же в конце находится символ Звездочки (*), то из диапазона сохраняются только нечетные числа;
    * Поиск соответствующих УИДов в DataFrame addresses_df и добавление их в список houses_uuids.
